name: 🚀 Deploy Service to AWS Lambda

# Se ejecuta en cada push a la rama 'main'
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production  # opcional, útil si usas GitHub Environments

    env:
      AWS_REGION: us-west-1  # asegúrate que coincide con tu serverless.yml
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      # 1️⃣ Checkout del repositorio
      - name: 📦 Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Instalar Node.js
      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'   # Coincide con tu runtime nodejs20.x
          cache: 'npm'

      # 3️⃣ Instalar dependencias
      - name: 📥 Install dependencies
        run: npm ci

      # 4️⃣ Instalar Serverless Framework (global)
      - name: 🧰 Install Serverless Framework
        run: npm install -g serverless

      # 5️⃣ Desplegar a AWS Lambda
      - name: 🚀 Deploy Serverless Service
        run: |
          echo "Starting deployment to production..."
          npx serverless deploy --stage production --verbose

